---
title: "STAA57 W21 - Project Proposal"
author: 'Group 4 (Adham F, Jason Y, Mohamed T, Wesley M)'
output:
  pdf_document: default
  html_document: default
---

### Analysis Plan 

*Specify the questions you will address. Describe the general topic of your investigation, and state specific questions you will address. Include any relevant information.*

We will be examining the average aircraft operating costs and the total aircraft operating costs for DFC. The factors that influence the cost are fuel, weather and COVID-19. Fuel and weather affect the average aircraft operating costs while COVID-19 affects total demand and indirectly affects fuel thus the average aircraft operating costs as well. Due to the multidimensional impact of COVID-19 affecting fuel and total demand, there is going to be a comparison between the year 2020 and the average of the previous years. In this paper, demand is defined as the number of sessions.

1. Demand over month/season vs COVID:
    - Average demand for each month/seasons using all 2016-2020 data
    - Average demand for each month/seasons using 2016-2019 data vs 2020 data (COVID)
2. Impact of COVID on fuel costs:
    - Average fuel costs before COVID
    - Fuel costs after COVID
3. Weather impact on aircraft operating costs: (independent of COVID and same as optimization)
4. Total Cost over month/season vs COVID
    - Total Average Cost for each month/season using 2016-2020 data
    - Total Average Cost for each month/seasons using 2016-2019 data vs 2020 data (COVID)
5. Demand and cost overall vs COVID
    - Yearly demand and total cost: 2017 vs 2018 vs ...

*Specify your data analysis plan. Describe (in words) how you will address these questions using data.*

We managed to collect from external sources that included overall operation cost for aircraft as well as weather data as well as fuel prices over the past 4 years. We hope through proper statistical analysis we would be able to find trends and correlations between these and what would potentially be the best times and conditions for the company to reduce costs

In general, we need to aggregate the data by month and year to see trends across seasons, as well as years (Covid vs non-covid). 
To calculate demand we will aggregate flight hours by summation, and to calculate costs, we will factor in external factors and aggregate by averaging.
In order to answer question 3, further research is required to see if and how flying conditions affect overall operating costs.

### Data

```{r , results='hide', include=FALSE, warning=FALSE}
source(file = "preprocess_data.R")
```
*Specify your data sources, and the type of information you will use (for external data, provide links/references). For each data source, describe the variables and observations used in your analysis. Identify any potential issues (e.g. bias).*  

We plan on using the following external data sources:

1. Weather (https://climate.weather.gc.ca/historical_data/search_historic_data_e.html)
    - Historical weather data by day, including temp, precipitation, wind, etc.
    - No data for oshawa. We are assuming that data from another Toronto location (TORONTO BUTTONVILLE A) is accurate enough.
2. Fuel (https://www.indexmundi.com/commodities/?commodity=jet-fuel&months=240&currency=cad)
    - Historical fuel data by month, including the cost/gallon and %change
    - Assuming that all planes used in the flight school use the same fuel
3. Operating costs and repairs (https://cessna150152club.org/Costs) 
    - The annual operating cost of a cessna plane model.
    - A static value, since the models being used are very similar


*Provide the R code that imports the data into R, and formats them appropriately (this can go to the appendix if it is too lengthy). Submit a copy of your external data files, if any. *
```{r , results='hide', include=FALSE, warning=FALSE}
library(rvest)
webpage<-read_html("https://www.indexmundi.com/commodities/?commodity=jet-fuel&months=240&currency=cad")
tbls <- html_nodes(webpage, "table") %>%
        html_table(fill = TRUE)
fuel_prices<-as.data.frame(tbls[2])
colnames(fuel_prices) <- c("Month_Year", "Price","Change")
clean_data_processed$Month_Words<-month.abb[clean_data_processed$Month]
clean_data_processed$Month_Year <-(str_c(clean_data_processed$Month_Words, clean_data_processed$Year, sep = " "))

clean_data_processed<-left_join(clean_data_processed,fuel_prices,by="Month_Year",copy = TRUE)
clean_data_processed <-select(clean_data_processed, -c("Month_Year","Change","Month_Words"))
colnames(clean_data_processed)[colnames(clean_data_processed) == 'Price'] <- 'Fuel Price Per Gallon'
```


### Preliminary Results

*Create at least three data summaries/visualisations which are relevant to your questions, and comment on your results. *

```{r , results='hide', include=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(ggpubr)
```

```{r, echo = FALSE, warning=FALSE, message=FALSE}
clean_data_processed %>%
  distinct(Year, Month, Day, .keep_all = T) %>%
  mutate_if(is.numeric, replace_na, 0) %>%
  mutate(date = make_date(Year, Month, Day)) %>%
  ggplot(aes(x=date, y=`Fuel Price Per Gallon`)) + 
  geom_line(position="dodge", stat="identity", color="darkblue") +
  xlab('Date') + ylab('Fuel Price Per Gallon') +
  labs(title='Fuel Price Per Gallon Time Series')
```

```{r , echo = FALSE, warning=FALSE}
getSeason <- function(month) {
    ifelse(month >= 3 & month <= 5, "Spring",
           ifelse(month >= 6 & month <= 8, "Summer",
                  ifelse(month >= 9 & month <= 11, "Fall", "Winter")))
}
```

```{r , echo = FALSE, warning=FALSE}
data_with_season <- clean_data_processed %>%
  mutate(season = getSeason(Month))
```

```{r , echo = FALSE, warning=FALSE}
# calculating the demand of the flight training
data_with_covid <- data_with_season %>% 
  mutate(during_covid = Year >= 2020)
```

```{r , echo = FALSE, warning=FALSE, message=FALSE}
# Duration By Month (2016 - 2019 vs 2020) | Side by Side Bar Chart
side_by_side_duration_month <- data_with_covid %>%
  distinct(Training_Type, Session_ID, .keep_all = T) %>%
  mutate_if(is.numeric, replace_na, 0) %>%
  group_by(Month, during_covid, Year) %>%
  summarise(total_duration = sum(Duration)) %>%
  summarise(avg_duration_per_month = mean(total_duration)) %>%
  ggplot(aes(x=factor(month.abb[Month], level=month.abb), y=avg_duration_per_month, fill=during_covid)) + 
  geom_bar(position="dodge", stat="identity") +
  xlab('Month') + ylab('Duration') +
  scale_x_discrete(breaks = c('Jan', 'Mar', 'May', 'Jul', 'Sep', 'Nov')) +
  labs(title='Avg Duration Per Month')
```

```{r , echo = FALSE, warning=FALSE, message=FALSE}
# Duration By Month  | Total Bar Chart
single_duration_month <-data_with_covid %>%
  distinct(Training_Type, Session_ID, .keep_all = T) %>%
  mutate_if(is.numeric, replace_na, 0) %>%
  group_by(Month, Year) %>%
  summarise(total_duration = sum(Duration)) %>%
  summarise(avg_duration_per_month = mean(total_duration)) %>%
  ggplot(aes(x=factor(month.abb[Month], level=month.abb), y=avg_duration_per_month)) + 
  geom_bar(position="dodge", stat="identity", color="darkblue", fill="darkblue") +
  xlab('Month') + ylab('Duration') +
  labs(title='Avg Duration Per Month')
```

```{r , echo = FALSE, warning=FALSE, message=FALSE}
# Duration By Season (2016 - 2019 vs 2020) | Side by Side Bar Chart
side_by_side_duration_season <- data_with_covid %>%
  distinct(Training_Type, Session_ID, .keep_all = T) %>%
  mutate_if(is.numeric, replace_na, 0) %>%
  group_by(season, during_covid, Year) %>%
  summarise(total_duration = sum(Duration)) %>%
  summarise(avg_duration_per_month = mean(total_duration)) %>%
  ggplot(aes(x=factor(season, level=c('Winter', 'Spring', 'Summer', 'Fall')), y=avg_duration_per_month, fill=during_covid)) + 
  geom_bar(position="dodge", stat="identity") +
  xlab('Season') + ylab('Duration') +
  labs(title='Avg Duration Per Season')
```
```{r , echo = FALSE, warning=FALSE, message=FALSE}
# Duration By Season | Total Bar Chart
single_duration_season <-data_with_covid %>%
  distinct(Training_Type, Session_ID, .keep_all = T) %>%
  mutate_if(is.numeric, replace_na, 0) %>%
  group_by(season, Year) %>%
  summarise(total_duration = sum(Duration)) %>%
  summarise(avg_duration_per_month = mean(total_duration)) %>%
  ggplot(aes(x=factor(season, level=c('Winter', 'Spring', 'Summer', 'Fall')), y=avg_duration_per_month)) + 
  geom_bar(position="dodge", stat="identity", fill="darkblue") +
  xlab('Season') + ylab('Duration') +
  labs(title='Avg Duration Per Season')
```

```{r , echo = FALSE, warning=FALSE, message=FALSE}
ggarrange(side_by_side_duration_month, single_duration_month, side_by_side_duration_season, single_duration_season)
```

```{r , echo = FALSE, warning=FALSE, message=FALSE}
total_demand_by_year <- clean_data_processed %>%
  filter(Aircraft %in% c('C-172', 'C-150', 'C-152', 'FMX-1000')) %>%
  distinct(Session_ID, Training_Type, .keep_all=T) %>%
  group_by(Year)  %>%
  summarise(total_duration = sum(as.numeric(Duration)))  %>%
  ggplot(aes(x=Year, y=total_duration)) + geom_bar(stat = "identity", color="darkblue", fill="darkblue") +
  labs(title='Total Demand of Each Year')
total_demand_by_year
```


```{r , echo = FALSE, warning=FALSE, message=FALSE}
# Total:
clean_data_processed %>%
  filter(Aircraft %in% c('C-172', 'C-150', 'C-152', 'FMX-1000')) %>%
  group_by(Aircraft) %>%
  summarise(average_duration = sum(as.numeric(Duration))/4) %>%
  ggplot(aes(x=Aircraft, y=average_duration)) + geom_bar(stat = "identity", position="dodge", color="darkblue", fill="darkblue") +
  labs(title='Avg Demand of Each Aircraft Model')

# Non-COVID
clean_data_processed %>%
  filter(Year <= '2020') %>%
  group_by(Aircraft) %>%
  filter(Aircraft %in% c('C-172', 'C-150', 'C-152', 'FMX-1000')) %>%
  summarise(average_duration = sum(as.numeric(Duration))/4) %>%
  ggplot(aes(x=Aircraft, y=average_duration)) + geom_bar(stat = "identity", position="dodge", color="darkblue", fill="darkblue") +
  labs(title='Avg Demand of Each Aircraft During Non-COVID Years')

# COVID
clean_data_processed %>%
  filter(Year == '2020') %>%
  group_by(Aircraft) %>%
  filter(Aircraft %in% c('C-172', 'C-150', 'C-152', 'FMX-1000')) %>%
  summarise(total_duration = sum(as.numeric(Duration))) %>%
  ggplot(aes(x=Aircraft, y=total_duration)) + geom_bar(stat = "identity", position="dodge", color="darkblue", fill="darkblue") +
  labs(title='Demand of each Aircraft During COVID Year (2020)')
```


```{r , echo = FALSE, warning=FALSE, message=FALSE}

clean_data_processed %>%
  filter(Aircraft %in% c('C-172', 'C-150', 'C-152', 'FMX-1000')) %>%
  group_by(Aircraft, Month) %>%
  summarise(mean_duration_per_month = sum(as.numeric(Duration)) / 4) %>%
  arrange(Month) %>%
  ggplot(aes(x=factor(month.abb[Month], level=month.abb), y=mean_duration_per_month, fill=Aircraft)) + 
  geom_bar(stat = "identity", position="dodge") +
  xlab('Month') +
  ylab('Average Duration') + 
  labs(title='Avg Aircraft Model Demand on a Monthly Basis')
```


```{r , echo = FALSE, warning=FALSE, message=FALSE}
clean_data_processed %>%
  filter(Aircraft %in% c('C-172', 'C-150', 'C-152', 'FMX-1000')) %>%
  mutate(Season = getSeason(Month)) %>%
  group_by(Aircraft, Season) %>%
  summarise(mean_duration_per_season = sum(as.numeric(Duration)) / 4) %>%
  arrange(Season) %>%
  ggplot(aes(x=Season, y=mean_duration_per_season, fill=Aircraft)) + 
  geom_bar(stat = "identity", position="dodge") +
  xlab('Season') +
  ylab('Average Duration') + 
  labs(title='Avg Aircraft Model Demand on a Seasonal Basis')
```