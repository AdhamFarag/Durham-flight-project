---
output: pdf_document
fontsize: 11pt
geometry: margin=1in
---

```{r, include = FALSE }
knitr::opts_chunk$set( echo=FALSE, # hide code from document
                       warning=FALSE, # hide warnings 
                       message=FALSE) # hide messages 
library(tidyverse)
```

# STAA57 W21 Draft Report 

Group 4 (Adham F, Jason Y, Mohamed T, Wesley M)

Link to RStudio Cloud shared project: https://rstudio.cloud/

***

## Introduction 

(*Description of questions that are being investigated*)

1. What are the trends in jet fuel costs over different time units (months/season)?
  - For this question we use the web scrapped to see how fuel price changes during time and we try to see how these changes affect the cost of flight or session for the company

2. What factors affect cost in a significant matter (model 1)
  - we decide here to use a linear regression model to assess significant facotrs to how cost is affected
  
3. What factors affect the duration of the same sets of exercises (model 2)
  - we decide here to use a linear regression model to assess significant facotrs to how duration of session is affected

4. What are the trends in demand over different time units (months/season/year)? 
 - we find how the demand in flight training changes and was season is more significant 

5. Considering the previous questions, what are the estimated average aircraft operating over different time units (months/season)?  

6. What are the total aircraft operating costs over month/season/year?  
  - assuming we know total number of planes

### Data 
```{r , results='hide', include=FALSE, warning=FALSE}
source(file = "preprocess_data.R")
```

The external data that is used in this project were gathered from the following sources:
  
  - AVGAS: (NEW LINK)
      - From preliminary research, it was found that C-172, C-150 and C-152 aircraft models only consume jet fuel (https://airshare.com/blog/cessna-172/#:~:text=and%20accessible%20training.-,What%20type%20of%20fuel%20does%20it%20use%3F,to%20power%20it%27s%20piston%20engine)
      - The AVGAS historical data from BLANK is given by month, including the cost per gallon and percentage change

  - Maintenance costs and repairs (https://cessna150152club.org/Costs):
      - The annual operating cost of a cessna plane model for maintenance and repairs
      - Based on this research,an assumed 15 dollar static cost per hour was added to each training session cost
      - In addition, the fuel consumption per hour is estimated to be 6
	
  - Weather (https://climate.weather.gc.ca/historical_data/search_historic_data_e.html):
		  - Historical weather data by day, including temp, precipitation, wind, etc.
		  - Gathered data from Oshawa location

## Analysis 

### Question 1: What are the trends in jet fuel costs over different time units (months/season)?
```{r}
fuel_by_month <- cleaned_fuel_prices %>%
  group_by(Month) %>%
  summarise(Avg_Price_Per_Gallon = mean(Price)) %>%
  ggplot(aes(x=Month, y=Avg_Price_Per_Gallon)) +
  geom_bar(stat="identity", fill="darkblue") +
  coord_cartesian(ylim=c(1.9, 2.2)) + 
  ylab("Avg Price Per Gallon") +
  labs(title="Fuel Price By Month ('16-'20)")

fuel_by_season <- cleaned_fuel_prices %>%
  group_by(Season) %>%
  summarise(Avg_Price_Per_Gallon = mean(Price)) %>%
  ggplot(aes(x=Season, y=Avg_Price_Per_Gallon)) +
  geom_bar(stat="identity", fill="darkblue") +
  coord_cartesian(ylim=c(1.9, 2.2)) + 
  ylab("Avg Price Per Gallon") +
  labs(title="Fuel Price By Season ('16-'20)")

ggarrange(fuel_by_month, fuel_by_season)
```
From the monthly data on the left, we can see that in March and April the fuel price is significantly cheaper than any other month at a price around \$1.91/gallon. Following that, it steadily increases and peaks around \$2.15/gallon around October and December.

For the seasonal data on the right, we can see that spring is significantly cheaper than any other season with a price at around \$1.94/gallon. On the other hand, fuel price is most expensive in the fall season with a price of about \$2.13/gallon

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.height=2}
clean_data_processed %>%
  distinct(Year, Month, Day, .keep_all = T) %>%
  mutate_if(is.numeric, replace_na, 0) %>%
  ggplot(aes(x=Date, y=`Fuel Price Per Gallon`)) + 
  geom_line(position="dodge", stat="identity", color="darkblue") +
  xlab('Time') + ylab('Fuel Price Per Gallon') +
  scale_x_date(breaks = 'year') +
  labs(title='Fuel Price Per Gallon Time Series')
```
From the above graph, it can be seen there was a significant decrease in the jet fuel price per gallon, leading to lower aircraft operating costs. Therefore, we expect that the average and total estimated aircraft costs to be lower in 2020.

### Question 3: What factors affect the duration of the same sets of exercises?

### How was the data prepared?
For sessions that perform a particular exercise set, we suspect that their total duration should be around the average total duration for that same exercise set, unless there are external factors that affect it. Thus we can utilize a multiple linear regression model to show any significance for external factors against duration.

To prepare the data for our model, we first have to group the data by exercise set. Noting that there are a lot of unique exercise combinations we took the three most popular exercise routines and split them into individual data sets as we deemed that to have enough data for this analysis. Within each data set, we would create a model on it and measure the results individually.

We also noted that we have to compute the total duration for a single session since a single session might have multiple training types resulting in multiple rows. Therefore we aggregated the rows to get the total duration for a particular session. To do this we can simply grouped by `Session_ID` and added the duration.

As a minor note, we also removed sessions that occurred on the ground as we wanted our model to only measure duration with real planes against external factors.

Lastly, to add on the external factors we joined our weather data to the processed data set.

After the data was prepared, we kept only the rows that came from the top 3 most frequent exercise sets and split them as mentioned above.

---

Since the cost per session is directly affected by the session's duration, it was decided to investigate which weather factors impact a session's duration. To answer this, we first identified a set of weather factors that we believed could have a strong effect on the duration of a session. These were:

* avg_relative_humidity
* avg_dew_point
* avg_pressure_sea
* avg_pressure_station
* avg_visibility
* avg_health_index
* precipitation
* avg_cloud_cover_4
* avg_temperature

Next, since we believed it was possible that the set of exercises chosen could directly affect the duration, thus we set them as a constant.
This was done by taking the top 3 most common groups of exercises, and creating a linear regression model for each of them.
```{r}
library(broom)
data_exercises %>% 
  group_by(Exercises) %>%
  summarise(count=n()) %>%
  arrange(desc(count)) %>%
  slice(1:3) %>% 
  knitr::kable( caption = "Top 3 Freq. Exercises")

data_exercises_top_1 <- data_exercises %>%
  filter(Exercises == '16,17,18,30')

data_exercises_top_2 <- data_exercises %>%
  filter(Exercises == '16,17,18')

data_exercises_top_3 <- data_exercises %>%
  filter(Exercises == '16,17,18,23,30')
```

Here are the p-values for the factors from each of the 3 models:
```{r}
top_1_exercise_lm_out = lm(Total_Duration ~ 
                        avg_relative_humidity +
                        avg_dew_point +
                        avg_pressure_sea +
                        avg_pressure_station +
                        avg_visibility +
                        avg_health_index +
                        avg_cloud_cover_4 + 
                        avg_temperature + 
                        min_windchill +
                        precipitation + Aircraft - 1, 
                      data = data_exercises_top_1)
#summary(top_1_exercise_lm_out)

top_1_exercise_lm_out %>%
  tidy() %>%
  arrange(p.value) %>%
  select(term, p.value, estimate) %>% 
  knitr::kable( caption = "P values for '16,17,18,30'")
plot(top_1_exercise_lm_out$residuals, top_1_exercise_lm_out$fitted.values)


top_2_exercise_lm_out = lm(Total_Duration ~ 
                        avg_relative_humidity +
                        avg_dew_point +
                        avg_pressure_sea +
                        avg_pressure_station +
                        avg_visibility +
                        avg_health_index +
                        avg_cloud_cover_4 + 
                        avg_temperature + 
                        precipitation + Aircraft - 1, 
                      data = data_exercises_top_2)
#summary(top_2_exercise_lm_out)
top_2_exercise_lm_out %>%
  tidy() %>%
  arrange(p.value) %>%
  select(term, p.value, estimate) %>% 
  knitr::kable( caption = "P values for '16,17,18'")
plot(top_2_exercise_lm_out$residuals, top_2_exercise_lm_out$fitted.values)

top_3_exercise_lm_out = lm(Total_Duration ~ 
                        avg_relative_humidity +
                        avg_dew_point +
                        avg_pressure_sea +
                        avg_pressure_station +
                        avg_visibility +
                        avg_health_index +
                        avg_cloud_cover_4 + 
                        avg_temperature + 
                        precipitation + Aircraft - 1, 
                      data = data_exercises_top_3)
#summary(top_3_exercise_lm_out)

top_3_exercise_lm_out %>%
  tidy() %>%
  arrange(p.value) %>%
  select(term, p.value, estimate) %>% 
  knitr::kable( caption = "P values for '16,17,18,23,30'")
# residual plot
plot(top_3_exercise_lm_out$residuals, top_3_exercise_lm_out$fitted.values)

```


From these results we could not identify any common features between the three models.
Additionally, for all models, all factors have a p-value > 0.05 and thus individually are not statistically significant.
We can conclude that 

### Some Sub-section Title     


(*R output tables can be formatted nicely in .html with* `knitr::kable()`) 

```{r, echo = FALSE}
tibble( X = c("this", "my"), 
        Y = c("is", "table") ) %>% 
  knitr::kable( caption = "Table Caption")
```



## Summary 

(*Recap of your findings and conclusions*)


***  

# Appendix
## Import/Format Data 
```
library(tidyverse)
library(lubridate)
library(ggpubr)
library(rvest)
rm(list = ls())

raw_data = NULL
for( i in 1:17){
  tmp = readxl::read_xlsx( "data/UofT Data Set.xlsx", skip = 1, sheet = i, 
                           col_names =  paste( "X", 1:12, sep="" ) ) %>% 
    mutate( Instructor_ID = i,
            PPL = X1,
            X1 = replace( X1, !str_detect(X1, "Student"), NA ),
            PPL = zoo::na.locf( PPL ),
            X1 = zoo::na.locf(X1) )
  raw_data = bind_rows( raw_data, tmp )
}
rm(tmp,i)

names( raw_data  ) = c( "Student", "Year", "Month", "Day", "Aircraft", "LF_dual", 
                        "LF_solo", "Instrument_AC",  "Instrument_Sim", "CC_dual", "CC_solo", "Exercises",
                        "Instructor_ID", "Licence")

head(raw_data)

raw_data %>%
  filter( !is.na(Year), Year != "Year",
          Year >= 2016, Year <= 2020,) %>% 
  mutate_at( .vars = c(2:4), .funs = as.integer ) %>% 
  mutate_at( .vars = c(6:11), .funs = as.numeric ) %>% 
  mutate( Aircraft = str_to_upper(Aircraft),
          Aircraft = replace( Aircraft, str_detect(Aircraft, "GROUND"), "GROUND"),
          Aircraft = replace_na( Aircraft, "NA"),
          Aircraft = replace(Aircraft, Aircraft=="C152", "C-152"),
          Month = replace(Month, Month==111, 11),
          Other = ifelse( str_detect(Aircraft,"GROUND|NA"), -1, NA ),
          Student_ID = as.numeric( factor( paste( Student, Instructor_ID) ) ), 
          Session_ID = row_number() ) %>% 
  gather( key = "Training_Type", value = "Duration", 6:11, Other) %>% 
  filter( !is.na(Duration) ) %>% 
  mutate( Duration  = na_if(Duration, -1),
          Aircraft = na_if(Aircraft, "NA")) %>% 
  select( Instructor_ID, Student_ID, Session_ID, Year, Month, Day, 
          Aircraft, Duration, Training_Type, Exercises, Licence ) -> clean_data

getSeason <- function(month) {
  ifelse(month >= 3 & month <= 5, "Spring",
         ifelse(month >= 6 & month <= 8, "Summer",
                ifelse(month >= 9 & month <= 11, "Fall", "Winter")))
}

clean_data_processed = clean_data %>% 
  distinct( Session_ID, .keep_all = T) %>% 
  # split the exercises string into a "list" column w str_split()
  mutate( Exercises = str_split(Exercises, ",") ) %>%  
  # and expand list contents into multiple rows w/ unnest()
  unnest(Exercises) %>%
  # remove invalid exercises
  mutate(Exercises = as.integer(Exercises)) %>%
  filter(Exercises >= 1 & Exercises <= 30) %>%
  distinct_all() %>%
  mutate(
    Season = getSeason(Month), 
    Date = make_date(Year, Month, Day), 
    COVID = Year >= 2020
  )

# reading in the fuel per gallon price
webpage <- read_html("https://www.indexmundi.com/commodities/?commodity=jet-fuel&months=240&currency=cad")
tbls <- html_nodes(webpage, "table") %>%
  html_table(fill = TRUE)
fuel_prices <- as.data.frame(tbls[2])
colnames(fuel_prices) <- c("Month_Year", "Price","Change")
clean_data_processed$Month_Words <- month.abb[clean_data_processed$Month]
clean_data_processed$Month_Year <- (str_c(clean_data_processed$Month_Words, clean_data_processed$Year, sep = " "))

clean_data_processed <- left_join(clean_data_processed,fuel_prices,by="Month_Year",copy = TRUE)
clean_data_processed <- select(clean_data_processed, -c("Month_Year","Change","Month_Words"))
colnames(clean_data_processed)[colnames(clean_data_processed) == 'Price'] <- 'Fuel Price Per Gallon'

process_weather <- function(data) {
  data %>% 
    select(
      'Date/Time', 
      "Mean Temp (Â°C)",
      "Total Precip (mm)",
      "Total Rain (mm)", 
      "Total Snow (cm)", 
      "Spd of Max Gust (km/h)"
    ) %>% 
    mutate(wind = as.character(`Spd of Max Gust (km/h)`)) %>%
    select(-c("Spd of Max Gust (km/h)")) %>%
    mutate(wind = ifelse(wind == '<31', 31, wind))
}

climate_data_2016 <- read_csv('data/en_climate_daily_ON_6158410_2016_P1D.csv') %>% process_weather()
climate_data_2017 <- read_csv('data/en_climate_daily_ON_6158410_2017_P1D.csv') %>% process_weather()
climate_data_2018 <- read_csv('data/en_climate_daily_ON_6158410_2018_P1D.csv') %>% process_weather()
climate_data_2019 <- read_csv('data/en_climate_daily_ON_6158410_2019_P1D.csv') %>% process_weather()
climate_data_2020 <- read_csv('data/en_climate_daily_ON_6158410_2020_P1D.csv') %>% process_weather()
climate_data <- bind_rows(climate_data_2016, 
                          climate_data_2017, 
                          climate_data_2018, 
                          climate_data_2019, 
                          climate_data_2020)

clean_data_processed <- left_join(clean_data_processed, climate_data, by=c("Date" = "Date/Time"), copy=True)

```
